AWSTemplateFormatVersion: "2010-09-09"
Description: "Creates an ECS task definition and service for running the Falcon Container Sensor"

Parameters:
  ECSClusterName:
    Type: String
    Description: Name of the ECS cluster where the service will run
  
  FalconCID:
    Type: String
    Description: CrowdStrike Falcon CID
  
  FalconImagePath:
    Type: String
    Description: Path to the Falcon Container image in ECR

Resources:
  FalconECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: crowdstrike-falcon-node-sensor
      RequiresCompatibilities:
        - EC2
      NetworkMode: bridge
      ContainerDefinitions:
        - Name: crowdstrike-falcon-node-sensor
          Image: !Ref FalconImagePath
          Essential: true
          Environment:
            - Name: FALCONCTL_OPT_CID
              Value: !Ref FalconCID
            - Name: FALCONCTL_OPT_TAGS
              Value: !Sub "ecs-cluster:${ECSClusterName}"
          MountPoints:
            - SourceVolume: falcon-sensor-kernels
              ContainerPath: /opt/CrowdStrike/falcon-sensor-kernels
              ReadOnly: false
          Privileged: true
      Volumes:
        - Name: falcon-sensor-kernels
          Host:
            SourcePath: /opt/CrowdStrike/falcon-sensor-kernels

  FalconECSService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: crowdstrike-falcon-node-daemon
      Cluster: !Ref ECSClusterName
      TaskDefinition: !Ref FalconECSTaskDefinition
      DesiredCount: 1
      LaunchType: EC2
      SchedulingStrategy: DAEMON
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0

Outputs:
  TaskDefinitionArn:
    Description: ARN of the created task definition
    Value: !Ref FalconECSTaskDefinition
  
  ServiceName:
    Description: Name of the created ECS service
    Value: !GetAtt FalconECSService.Name
